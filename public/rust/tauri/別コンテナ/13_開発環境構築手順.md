# 開発環境構築手順（WSL Ubuntu 22.04）

本ドキュメントは、警報ブザー付き無線中継器メンテナンスソフトウェアを Tauri 2 + SvelteKit 5 で開発するための VS Code Dev Container ベース環境の構築手順をまとめたものです。Docker Desktop は使用せず、WSL2 上の Ubuntu 22.04 と Docker Engine を前提としています。

## 1. 前提条件

- Windows 10/11 で WSL2 が有効化されていること
- WSL2 に Ubuntu 22.04 ディストリビューションが導入済みであること
- Ubuntu 上で Docker Engine が起動できること（`docker info` が成功する）
- Visual Studio Code と Remote Development 拡張機能（`ms-vscode-remote.remote-containers` / `ms-vscode-remote.remote-wsl` を含む）がインストールされていること

> **補足**: Docker Engine の導入方法は Microsoft Learn の「Install Docker on Ubuntu」および「WSL で Docker を使う」ドキュメントを参照してください。VPN やファイアウォール設定によりデーモン起動がブロックされる場合があります。

## 3. リポジトリの取得

WSL Ubuntu ターミナルで作業ディレクトリを作成し、リポジトリを取得します。以下はホームディレクトリ直下に配置する例です。

```bash
mkdir -p ~/workspace
cd ~/workspace
git clone <リポジトリ>
```

## 4. 開発コンテナの起動

* コンテナの起動については、以下２つの方法がある。

|No.|起動方法||
|--|--|--|
|1|docker-compose|コマンドからの操作|
|2|DevContainer|GUIからの操作。<br>※VSCodeの拡張機能「Dev Containers」が必要|

### 4-1. docker-composeからの操作

1. docker-compose.ymlがあるフォルダ(リポジトリ直下)で以下のコマンドを実行する。
   ``` bash
   > docker-compose up -d
   ```

   * 初回実行であれば、上記のコマンドでコンテナの作成から起動まで実行される。ただし、非常に時間がかかる。（体感３０分程度）
   * 初回でなければ、コンテナが立ち上がるだけで、すぐに実行可能。
1. ブラウザから「http://localhost:5173」に接続する。
1. 「Welcome to Tauri+Svelte」の画面が表示される

### 4-2. DevContainerからの起動

1. Dev Containersを入れていない場合は、VSCodeの拡張機能から検索してインストールしてください。
1. WSL ターミナルでリポジトリ直下から VS Code を起動します。

   ```bash
   code .
   ```

2. VS Code ステータスバーに `WSL: Ubuntu` と表示されていることを確認します。
3. コマンドパレット（`Ctrl+Shift+P`）で **Dev Containers: Reopen in Container** を実行します。
4. `.devcontainer/devcontainer.json` がルートの `Dockerfile` をビルドし、Node.js 22・rustup 管理の Rust toolchain（stable と `x86_64-pc-windows-gnu` ターゲット）・GTK 関連ライブラリ・NSIS・mingw-w64 などを含む開発環境を自動構築します。
5. 初回起動時は `.devcontainer/setup.sh` が実行され、`tauri-app` ディレクトリで `npm install` が走ります。

> コンテナ構築に失敗した場合は **Dev Containers: Rebuild Container Without Cache** を試すか、WSL 側で `docker image prune` を実行してから再ビルドしてください。

## 5. 開発フロー

### 5.1 依存パッケージの同期

依存関係を再取得したい場合はコンテナ内ターミナルで以下を実行します。

```bash
cd /workspaces/tauri-app
npm install
```

### 5.2 SvelteKit 開発サーバー

* docker-composeから起動させた場合は、すでに立ち上がっているため、以下のコマンドは実行不要。htmlソースを修正するのみでUIは変更されます。（ホットリロード）

```bash
cd /workspaces/tauri-app
npm run dev -- --host 0.0.0.0 --port 5173
```

- Dev Container のポートフォワード設定により、ホストブラウザから `http://localhost:5173` にアクセスできます。
- `--host 0.0.0.0` を付けることで、LAN 内デバイスからの動作確認も可能です。

### 5.3 Tauri デスクトップアプリ

```bash
cd /workspaces/tauri-app
npm run tauri dev
```

- WSLg が有効な環境では Linux 版 Tauri ウィンドウが表示されます。
- Windows ネイティブでの UI 確認が必要な場合は、ホスト側にも Rust / Node.js を導入して同コマンドを実行してください。

### 5.4 ビルド

- フロントエンドの静的ビルド:

  ```bash
  cd /workspaces/tauri-app
  npm run build
  ```

- デスクトップアプリのバンドル（Windows GNU ターゲット例）:

  ```bash
  cd /workspaces/tauri-app
  npm run tauri build -- --target x86_64-pc-windows-gnu
  ```

  成果物は `tauri-app/src-tauri/target/` 配下に生成されます。

## 6. リポジトリ構成

```text
.
├── .devcontainer/          # Dev Container 設定（Dockerfile を再利用）
├── Dockerfile              # 開発用ベースイメージ定義
├── docker-compose.yml      # 開発用サービス定義（任意で使用）
├── scripts/                # WSL/Ubuntu 取得スクリプト群
├── tauri-app/              # SvelteKit + Tauri プロジェクト
│   ├── package.json
│   ├── src/
│   └── src-tauri/
├── README.md               # プロジェクトの概要と手順
└── 13_開発環境構築手順.md # 本ドキュメント
```

## 7. トラブルシューティング

- **Docker デーモンに接続できない**: `sudo service docker start` → `docker info` で状態を確認。`/etc/docker/daemon.json` の設定誤りや VPN が原因の場合があります。
- **コンテナビルド時に依存パッケージ取得で失敗する**: プロキシ環境では `npm config set proxy` や `cargo env set proxy` を設定し、ビルドを再実行してください。
- **Tauri の GUI が表示されない**: `wsl --update` で WSLg を更新するか、Windows ネイティブで `npm run tauri dev` を実行して確認します。
- **Windows 向けバイナリのビルドに失敗する**: `mingw-w64` と `nsis` がコンテナ内で正しくインストールされているか確認し、必要に応じて `Dev Containers: Rebuild Container` を実行してください。

## 8. 保守のポイント

- Node.js や Rust のバージョンを変更する場合は `Dockerfile` を編集し、Dev Container を再ビルドしてください。
- `.devcontainer/` 内の設定を更新した際も再ビルドが必要です。
- プロジェクト依存 (`package.json`, `Cargo.toml`) を更新後にキャッシュをクリアしたい場合は **Dev Containers: Rebuild Container Without Cache** を利用します。
- WSL ディストリビューションや Docker Engine をアップデートした場合は、リポジトリ直下で `code .` から再度 Dev Container を開き直してください。

## 9. ネットワーク/プロキシ設定の目安

FortiGate などの証明書インスペクション付きプロキシを通過する場合、rustup の導入や Cargo によるクレート取得に必要なホスト名を事前に許可リストへ登録してください。代表的な接続先は以下の通りです。

- `sh.rustup.rs` — rustup インストーラースクリプト配信元
- `static.rust-lang.org` — Rust ツールチェーン／コンポーネント配信元（`RUSTUP_DIST_SERVER` / `RUSTUP_UPDATE_ROOT` でも参照）
- `crates.io` / `index.crates.io` — Cargo のパッケージ／インデックス配信元
- `github.com` / `raw.githubusercontent.com` — 一部クレートや依存バイナリが参照する場合あり

プロキシに独自証明書が挿入される場合は、`/usr/local/share/ca-certificates/` にルート証明書を配置した上で `update-ca-certificates` を実行し、Dev Container のベースイメージに取り込んだ後 `Dev Containers: Rebuild Container` で再構築してください。

## 10. 参考リンク

- [Tauri 公式ドキュメント](https://tauri.app)
- [SvelteKit ドキュメント](https://kit.svelte.dev/docs)
- [Microsoft Learn: WSL のインストール](https://learn.microsoft.com/windows/wsl/install)
- [Docker Docs: Install Docker Engine on Ubuntu](https://docs.docker.com/engine/install/ubuntu/)

以上。
